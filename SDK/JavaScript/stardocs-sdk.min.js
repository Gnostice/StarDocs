"use strict";var Gnostice=Gnostice||{};Gnostice.ConnectionInfo=function(e,t,s,r,o){this.apiServerVersion="2.0.0",this.apiServerUri=e||"",this.apiKey=t,this.apiSecret=s,this.serverTimeout=r||-1,this.docOperationTimeout=o||-1},Gnostice.ConnectionInfo.prototype.constructor=Gnostice.ConnectionInfo,Gnostice.DocPasswordSettings=function(e){this.forceFullPermission=e},Gnostice.DocPasswordSettings.prototype=Gnostice.DocPasswordSettings,Gnostice.Preferences=function(e){this.docPasswordSettings=e||new Gnostice.DocPasswordSettings(!1)},Gnostice.Preferences.prototype.constructor=Gnostice.Preferences,Gnostice.StarDocs=function(e,t){this.connectionInfo=e||new Gnostice.ConnectionInfo,this.preferences=t||new Gnostice.Preferences,this.uriSegAuthToken="/auth/token",this.uriSegDocs="/docs",this.uriSegDocsOps="/docs/ops",this.uriSegOps="/ops",this.uriSegInfo="/info",this.uriSegMetaTags="/meta/tags",this.uriSegMetaOwner="/meta/owner",this.uriSegMetaFilename="/meta/filename",this.uriSegUsers="/users",this.uriSegViewSessions="/viewsessions",this.uriSegMiscTags="/misc/tags",this.uriSegMiscGroups="/misc/groups",this.uriMiscPhysicalStores="/misc/physicalstores",this.uriMiscDocumenTreeViews="/misc/documenttreeviews",this.pollInterval=1e3,this.pollRetryMaxCount=600,this.documentPassword=null,this.setDocumentPassword=function(e){this.documentPassword=e};var s=function(e){this.starDocs=e,this.accessToken=null,this.loggedInUserName=null,this.grantType=null};s.prototype.constructor=s,s.prototype.loginUser=function(e,t){this.loggedInUserName=null,this.grantType=null;var s=this.starDocs.connectionInfo.apiServerUri+this.starDocs.uriSegAuthToken;console.log("In Auth.login: "+e);var r=this,o=$.ajax({url:s,type:"POST",dataType:"json",beforeSend:function(e){e.setRequestHeader("Authorization","Basic "+btoa(r.starDocs.connectionInfo.apiKey+":"+r.starDocs.connectionInfo.apiSecret))},headers:{"content-type":"application/x-www-form-urlencoded"},data:{grant_type:"password",username:e,password:t}});return o.then(function(e,t,s){return"success"==t?(r.setAccessToken(e.access_token,"password"),$.Deferred().resolve(e).promise()):void 0},function(e,t,s){return r.setAccessToken(null,null),$.Deferred().reject(e.status,s,e.responseJSON).promise()})},s.prototype.loginApp=function(e){this.loggedInUserName=null,this.grantType=null;var t=this.starDocs.connectionInfo.apiServerUri+this.starDocs.uriSegAuthToken;null!==e&&(t+="?entity_id="+e),console.log("In loginApp");var s=this,r=$.ajax({url:t,type:"POST",dataType:"json",beforeSend:function(e){e.setRequestHeader("Authorization","Basic "+btoa(s.starDocs.connectionInfo.apiKey+":"+s.starDocs.connectionInfo.apiSecret))},headers:{"content-type":"application/x-www-form-urlencoded"},data:{grant_type:"client_credentials"}});return r.then(function(e,t,r){return"success"==t?(s.setAccessToken(e.access_token,"client_credentials"),$.Deferred().resolve(e).promise()):void 0},function(e,t,r){return s.setAccessToken(null,null),$.Deferred().reject(e.status,r,e.responseJSON).promise()})},s.prototype.setAccessToken=function(e,t){this.accessToken=e,null!==t&&(this.grantType=t)};var r=function(e){this.starDocs=e};r.prototype.constructor=r,r.prototype.upload=function(e,t){console.log("Uploading "+e);var s=new FormData;s.append("fileUpload",e),null!=t&&s.append("password",t),s.append("forceFullPermission",this.starDocs.preferences.docPasswordSettings.forceFullPermission);var r=this.starDocs.connectionInfo.apiServerUri+this.starDocs.uriSegDocs,o=this.starDocs.doAjaxWithBody("POST",r,s);return o.then(function(e,t,s){return $.Deferred().resolve(e).promise()},function(e,t,s){return $.Deferred().reject(e.status,s,e.responseJSON).promise()})},r.prototype.listFiles=function(e,t,s){var r=[];e="all",e=e.toLowerCase(),r.push("sub_set="+e),$.isArray(s)?Array.prototype.push.apply(r,s):null!=s&&r.push(s);var o="";o=$.isArray(t)?t.join():t||"",r.push("include_details="+o);for(var n=this.starDocs.connectionInfo.apiServerUri+this.starDocs.uriSegDocs,i=0;i<r.length;++i)0===i&&(n+="?"),n+=r[i],i<r.length&&(n+="&");var c=this.starDocs.doAjax("GET",n);return c.then(function(e,t,s){return $.Deferred().resolve(e).promise()},function(e,t,s){return $.Deferred().reject(e.status,s,e.responseJSON).promise()})},r.prototype.download=function(e,t){if(console.log("Downloading "+e),"boolean"!=typeof t&&(t=!0),t){var s=e;return null!==this.starDocs.auth.accessToken&&(s+="?bearer_token="+this.starDocs.auth.accessToken),console.log("uri: "+s),$.Deferred().resolve(window.open(s,"_blank")).promise()}var r=this.starDocs.doAjax("GET",e,"text");return r.then(function(e,t,s){return $.Deferred().resolve(s.responseText).promise()},function(e,t,s){return $.Deferred().reject(e.status,s,e.responseJSON).promise()})},r.prototype.getDownloadUrl=function(e){var t=new URI(e);return null===this.starDocs.auth.accessToken?$.Deferred().reject(401,"You need to authenticate before calling this method.").promise():(t=t.setQuery("bearer_token",this.starDocs.auth.accessToken),$.Deferred().resolve(t).promise())},r.prototype["delete"]=function(e){console.log("Deleting "+e);var t=this.starDocs.doAjax("DELETE",e);return t.then(function(e,t,s){return $.Deferred().resolve().promise()},function(e,t,s){return $.Deferred().reject(e.status,s,e.responseJSON).promise()})},r.prototype.setTags=function(e,t){console.log("Setting tags on  "+e);var s=e+this.starDocs.uriSegMetaTags,r=JSON.stringify({tags:t}),o=this.starDocs.doAjaxWithBody("POST",s,r,"application/json; charset=utf-8");return o.then(function(e,t,s){return $.Deferred().resolve().promise()},function(e,t,s){return $.Deferred().reject(e.status,s,e.responseJSON).promise()})},r.prototype.updateOwner=function(e,t,s,r){console.log("Updating owner for "+e);var o=e+this.starDocs.uriSegMetaOwner,n={user:{userNameEmail:t}};null!==s&&(n.resetSharing=s),null!==r&&(n.retainRights=r);var i=JSON.stringify(n),c=this.starDocs.doAjaxWithBody("PUT",o,i,"application/json; charset=utf-8");return c.then(function(e,t,s){return $.Deferred().resolve().promise()},function(e,t,s){return $.Deferred().reject(e.status,s,e.responseJSON).promise()})},r.prototype.rename=function(e,t){console.log("Updating filename for "+e);var s=e+this.starDocs.uriSegMetaFilename,r={fileName:t},o=JSON.stringify(r),n=this.starDocs.doAjaxWithBody("PUT",s,o,"application/json; charset=utf-8");return n.then(function(e,t,s){return"success"==t?$.Deferred().resolve().promise():void 0},function(e,t,s){return $.Deferred().reject(e.status,s,e.responseJSON).promise()})};var o=function(e){this.starDocs=e};o.prototype.constructor=o,o.prototype.merge=function(e,t,s){for(var r=this.starDocs.connectionInfo.apiServerUri+this.starDocs.uriSegDocsOps+"/merge",o={forceFullPermission:this.starDocs.preferences.docPasswordSettings.forceFullPermission,documents:[]},n=0;n<e.length;++n){var i={url:e[n]};null!=t&&(i.password=t[n]),null!=s&&(i.pageRange=s[n]),o.documents.push(i)}var c=JSON.stringify(o);return this.starDocs.doAjaxWithBodyAndPoll("POST",r,c,"application/json; charset=utf-8")},o.prototype.splitRange=function(e,t,s){var r=this.starDocs.connectionInfo.apiServerUri+this.starDocs.uriSegDocsOps+"/split-range",o={forceFullPermission:this.starDocs.preferences.docPasswordSettings.forceFullPermission,documents:[{url:e,pageRanges:[]}]};null!=t&&(o.documents[0].password=passwords),null!=s&&(o.documents[0].pageRanges=s);var n=JSON.stringify(o);return this.starDocs.doAjaxWithBodyAndPoll("POST",r,n,"application/json; charset=utf-8")},o.prototype.splitSeparatorPage=function(e,t){var s=this.starDocs.connectionInfo.apiServerUri+this.starDocs.uriSegDocsOps+"/split-separator",r={forceFullPermission:this.starDocs.preferences.docPasswordSettings.forceFullPermission,documents:[{url:e,separatorType:"emptyPage"}]};null!=t&&(r.documents[0].password=passwords);var o=JSON.stringify(r);return this.starDocs.doAjaxWithBodyAndPoll("POST",s,o,"application/json; charset=utf-8")},o.prototype.convertToBMP=function(e,t,s,r){return this.convertToImage("convert-bmp",e,t,s,r)},o.prototype.convertToGIF=function(e,t,s,r){return this.convertToImage("convert-gif",e,t,s,r)},o.prototype.convertToJPEG=function(e,t,s,r){return this.convertToImage("convert-jpeg",e,t,s,r)},o.prototype.convertToPNG=function(e,t,s,r){return this.convertToImage("convert-png",e,t,s,r)},o.prototype.convertToTIFF=function(e,t,s,r,o){return this.convertToImage("convert-tiff",e,t,s,r,o)},o.prototype.convertToMTIFF=function(e,t,s,r,o,n){return this.convertToImage("convert-mtiff",t,s,r,o,n,e)},o.prototype.convertToPDF=function(e,t,s,r,o){return this.convertToImage("convert-pdf",t,s,r,null,null,e,o)},o.prototype.encrypt=function(e,t,s,r,o,n){var i=e+this.starDocs.uriSegOps+"/encrypt",c={forceFullPermission:this.starDocs.preferences.docPasswordSettings.forceFullPermission};null!=t&&(c.password=passwords),null!=s&&(c.encryptionLevel=s),null!=r&&(c.newOpenPassword=r),null!=o&&(c.newPermissionsPassword=o),null!=n&&(c.newPermissions=n);var a=JSON.stringify(c);return this.starDocs.doAjaxWithBodyAndPoll("PUT",i,a,"application/json; charset=utf-8")},o.prototype.redactText=function(e,t,s,r,o,n,i,c,a){var u=e+this.starDocs.uriSegOps+"/redact-text",l={forceFullPermission:this.starDocs.preferences.docPasswordSettings.forceFullPermission};null!=t&&(l.password=passwords),null!=s&&(l.pageRange=s),null!=r&&(l.searchMode=r),null!=o&&(l.searchText=o),null!=n&&(l.removeAssociatedAnnotations=n),null!=i&&(l.fillSettings=i),null!=c&&(l.includeAdditionalItems=c),null!=a&&(l.cleanupSettings=a);var p=JSON.stringify(l);return this.starDocs.doAjaxWithBodyAndPoll("PUT",u,p,"application/json; charset=utf-8")},o.prototype.fillForm=function(e,t,s,r){var o=e+this.starDocs.uriSegOps+"/fill-form",n={forceFullPermission:this.starDocs.preferences.docPasswordSettings.forceFullPermission};null!=t&&(n.password=t),null!=s&&(n.fields=s),r===!0&&(n.flattenAllFields=r);var i=JSON.stringify(n);return this.starDocs.doAjaxWithBodyAndPoll("PUT",o,i,"application/json; charset=utf-8")},o.prototype.convertToImage=function(e,t,s,r,o,n,i,c){for(var a=this.starDocs.connectionInfo.apiServerUri+this.starDocs.uriSegDocsOps+"/"+e,u={forceFullPermission:this.starDocs.preferences.docPasswordSettings.forceFullPermission,documents:[]},l=0;l<t.length;++l){var p={url:t[l]};null!=s&&(p.password=s[l]),null!=r&&(p.pageRange=r[l]),u.documents.push(p)}null!=o&&(u.imageEncoderSettings=o),null!=n&&(u.tiffCompressionType=n),null!=i&&(u.conversionMode=i),null!=c&&(u.pdfEncoderSettings=c);var d=JSON.stringify(u);return this.starDocs.doAjaxWithBodyAndPoll("POST",a,d,"application/json; charset=utf-8")},o.prototype.getDocInfo=function(e,t){var s=new URI(e).segment(this.starDocs.uriSegInfo).setQuery("force-full-permission",this.starDocs.preferences.docPasswordSettings.forceFullPermission);return null!=t?s=s.setQuery("password",t):null!=this.starDocs.documentPassword&&(s=s.setQuery("password",this.starDocs.documentPassword)),this.starDocs.doAjaxAndPoll("GET",s.toString())},o.prototype.getPageImage=function(e,t,s){var r=new URI(e).setQuery("dpi",t).setQuery("force-full-permission",this.starDocs.preferences.docPasswordSettings.forceFullPermission);return null!=s?r=r.setQuery("password",s):null!=this.starDocs.documentPassword&&(r=r.setQuery("password",this.starDocs.documentPassword)),this.starDocs.doAjaxAndPoll("GET",r.toString())},o.prototype.getDocumentPrintImageURLs=function(e,t){var s=new URI(e).segment(this.starDocs.uriSegOps).segment("prepare-print-images"),r={forceFullPermission:this.starDocs.preferences.docPasswordSettings.forceFullPermission};null!=t?r.password=passwords:null!=this.starDocs.documentPassword&&(r.password=this.starDocs.documentPassword);var o=JSON.stringify(r),n=$.Deferred(),i=this;return this.starDocs.doAjaxWithBodyAndPoll("POST",s.toString(),o,"application/json; charset=utf-8").done(function(t){console.log("In getDocumentPrintImageURLs: Pages ready "+t);for(var s=[],r=t.largestRenderedPageCount,o=new URI(e).segment("pages"),c=1;r>=c;++c){var a=o.toString()+"/"+c+"/image",u=new URI(a).setQuery("bearer_token",i.starDocs.auth.accessToken).toString();s.push(u)}n.resolve(s)}).fail(function(e,t,s){console.log("In getDocumentPrintImageURLs: fail event called"),n.reject(e,t,s)}),n.promise()},o.prototype.getPageFormFields=function(e,t){var s=new URI(e).segment("formfields").setQuery("force-full-permission",this.starDocs.preferences.docPasswordSettings.forceFullPermission);return null!=t?s=s.setQuery("password",t):null!=this.starDocs.documentPassword&&(s=s.setQuery("password",this.starDocs.documentPassword)),this.starDocs.doAjaxAndPoll("GET",s.toString())},o.prototype.getPageText=function(e,t){var s=new URI(e).segment("text").setQuery("force-full-permission",this.starDocs.preferences.docPasswordSettings.forceFullPermission);return null!=t?s=s.setQuery("password",t):null!=this.starDocs.documentPassword&&(s=s.setQuery("password",this.starDocs.documentPassword)),this.starDocs.doAjaxAndPoll("GET",s.toString())};var n=function(e){this.starDocs=e};n.prototype.constructor=n,n.prototype.listUsers=function(){var e=this.starDocs.connectionInfo.apiServerUri+this.starDocs.uriSegUsers,t=this.starDocs.doAjax("GET",e);return t.then(function(e,t,s){return $.Deferred().resolve(e).promise()},function(e,t,s){return $.Deferred().reject(e.status,s,e.responseJSON).promise()})},n.prototype.getUserDetails=function(e){e=e||this.starDocs.connectionInfo.apiServerUri+this.starDocs.uriSegUsers+"/me";var t=this.starDocs.doAjax("GET",e);return t.then(function(e,t,s){return $.Deferred().resolve(e).promise()},function(e,t,s){return $.Deferred().reject(e.status,s,e.responseJSON).promise()})};var i=function(e){this.starDocs=e};i.prototype.constructor=i,i.prototype.createView=function(e,t,s){console.log("Creating viewer for doc "+e);var r=this.starDocs.connectionInfo.apiServerUri+this.starDocs.uriSegViewSessions;s=s||{},t=t||"";var o=JSON.stringify({forceFullPermission:this.starDocs.preferences.docPasswordSettings.forceFullPermission,documents:[{url:e,password:t}],viewerSettings:s}),n=this.starDocs.doAjaxWithBody("POST",r,o,"application/json; charset=utf-8");return n.then(function(e,t,s){return $.Deferred().resolve(e).promise()},function(e,t,s){return $.Deferred().reject(e.status,s,e.responseJSON).promise()})};var c=function(e){this.starDocs=e};c.prototype.constructor=c,c.prototype.getLookupTags=function(){var e=this.starDocs.connectionInfo.apiServerUri+this.starDocs.uriSegMiscTags,t=this.starDocs.doAjax("GET",e);return t.then(function(e,t,s){return $.Deferred().resolve(e).promise()},function(e,t,s){return $.Deferred().reject(e.status,s,e.responseJSON).promise()})},c.prototype.listGroups=function(){var e=this.starDocs.connectionInfo.apiServerUri+this.starDocs.uriSegMiscGroups,t=this.starDocs.doAjax("GET",e);return t.then(function(e,t,s){return $.Deferred().resolve(e).promise()},function(e,t,s){return $.Deferred().reject(e.status,s,e.responseJSON).promise()})},c.prototype.listPhysicalStores=function(){var e=this.starDocs.connectionInfo.apiServerUri+this.starDocs.uriMiscPhysicalStores,t=this.starDocs.doAjax("GET",e);return t.then(function(e,t,s){return $.Deferred().resolve(e).promise()},function(e,t,s){return $.Deferred().reject(e.status,s,e.responseJSON).promise()})},c.prototype.listDocumentTreeViews=function(){var e=this.starDocs.connectionInfo.apiServerUri+this.starDocs.uriMiscDocumenTreeViews,t=this.starDocs.doAjax("GET",e);return t.then(function(e,t,s){return $.Deferred().resolve(e).promise()},function(e,t,s){return $.Deferred().reject(e.status,s,e.responseJSON).promise()})},c.prototype.createDocumentTreeView=function(e,t){var s=this.starDocs.connectionInfo.apiServerUri+this.starDocs.uriMiscDocumenTreeViews,r=JSON.stringify({documentTreeView:{name:e,tagKeys:t}}),o=this.starDocs.doAjaxWithBody("POST",s,r,"application/json; charset=utf-8");return o.then(function(e,t,s){return $.Deferred().resolve(e).promise()},function(e,t,s){return $.Deferred().reject(e.status,s,e.responseJSON).promise()})},c.prototype.editDocumentTreeView=function(e,t,s){var r=JSON.stringify({documentTreeView:{name:t,tagKeys:s}}),o=this.starDocs.doAjaxWithBody("PUT",e,r,"application/json; charset=utf-8");return o.then(function(e,t,s){return $.Deferred().resolve().promise()},function(e,t,s){return $.Deferred().reject(e.status,s,e.responseJSON).promise()})},c.prototype.deleteDocumentTreeView=function(e){console.log("Deleting "+e);var t=this.starDocs.doAjax("DELETE",e);return t.then(function(e,t,s){return $.Deferred().resolve().promise()},function(e,t,s){return $.Deferred().reject(e.status,s,e.responseJSON).promise()})},this.auth=new s(this),this.storage=new r(this),this.docOperations=new o(this),this.userMgmt=new n(this),this.viewer=new i(this),this.misc=new c(this)},Gnostice.StarDocs.prototype.constructor=Gnostice.StarDocs,Gnostice.StarDocs.prototype.assertUserLogin=function(){if(null===this.auth.accessToken)throw new Error("Authentication required")},Gnostice.StarDocs.prototype.doAjax=function(e,t,s){var r=this;return $.ajax({url:t,type:e,dataType:s||"json",beforeSend:function(e){null!==r.auth.grantType&&null!==r.auth.accessToken&&e.setRequestHeader("Authorization","Bearer "+r.auth.accessToken)},contentType:!1,cache:!1,processData:!1})},Gnostice.StarDocs.prototype.doAjaxWithBody=function(e,t,s,r,o){var n=this;return $.ajax({url:t,type:e,dataType:o||"json",beforeSend:function(e){null!==n.auth.grantType&&null!==n.auth.accessToken&&e.setRequestHeader("Authorization","Bearer "+n.auth.accessToken)},data:s,contentType:r||!1,cache:!1,processData:!1})},Gnostice.StarDocs.prototype.doAjaxAndPoll=function(e,t,s){var r=this.doAjax(e,t,s),o=this;return r.then(function(e,t,s){if(200===s.status)return $.Deferred().resolve(e).promise();if(202===s.status){var r=$.Deferred(),n=new URI(s.getResponseHeader("location"));return o.preferences.docPasswordSettings.forceFullPermission&&(n=n.setQuery("force-full-permission",!0)),null!=o.documentPassword&&(n=n.setQuery("password",o.documentPassword)),setTimeout(o.doPoll,o.pollInterval,n.toString(),r,o,1),r.promise()}return $.Deferred().reject(s.status,t,s.responseJSON).promise()},function(e,t,s){return $.Deferred().reject(e.status,s,e.responseJSON).promise()})},Gnostice.StarDocs.prototype.doAjaxWithBodyAndPoll=function(e,t,s,r,o){var n=this.doAjaxWithBody(e,t,s,r,o),i=this;return n.then(function(e,t,s){if(201===s.status)return $.Deferred().resolve(e).promise();if(202===s.status){var r=$.Deferred(),o=s.getResponseHeader("location");return o=o+"?force-full-permission="+i.preferences.docPasswordSettings.forceFullPermission,null!=i.documentPassword&&(o=o+"&password="+encodeURIComponent(i.documentPassword)),setTimeout(i.doPoll,i.pollInterval,o,r,i,1),r.promise()}return $.Deferred().reject(s.status,t,s.responseJSON).promise()},function(e,t,s){return $.Deferred().reject(e.status,s,e.responseJSON).promise()})},Gnostice.StarDocs.prototype.doPoll=function(e,t,s,r){console.log("In doPoll: Polling "+e);var o=s.doAjax("GET",e);return o.then(function(o,n,i){if(200===i.status||201===i.status)console.log("In doPoll: done "+e),t.resolve(o);else if(202===i.status){if(console.log("In doPoll: output not yet ready "),++r,r>=s.pollRetryMaxCount)return console.log("In doPoll: Retry count exceeded "),void t.reject(200,"OK",0,"Exceeded poll retry count.");setTimeout(s.doPoll,s.pollInterval,e,t,s,r)}else console.log("In doPoll: Unexpected status code "+i.status),t.reject(i.status,n,i.responseJSON)},function(e,s,r){return console.log("In doPoll: error textStatus="+s+", errorThrown="+r),t.reject(e.status,r,e.responseJSON)})},Gnostice.StarDocs.prototype.parsePageRangeSettings=function(e){var t={range:""};if(e.length<1)return t;var s=e.indexOf("|");if(-1==s)return t.range=e,t;t.range=e.substring(0,s);var r=e.indexOf("|",s+1);return-1==r?(t.subRangeMode=e.substring(s+1),t):(t.subRangeMode=e.substring(s+1,r),t.reverseOrder="true"===e.substring(r+1).toLowerCase(),t)};